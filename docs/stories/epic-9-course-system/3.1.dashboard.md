# Story 3.1: Dashboard Page with Course Overview

## Status
Draft

## Story
**As a** learner,
**I want** a dashboard showing my course progress and gamification stats,
**so that** I can quickly see my learning status and continue where I left off.

## Acceptance Criteria
1. `/dashboard` page created (protected route)
2. Page displays user's current XP, streak, and level
3. Page shows list of available courses filtered by user's level
4. Each course card shows: title, description, level badge, progress bar
5. "Continue Learning" button appears on last active course
6. Mobile-responsive layout (cards stack vertically on small screens)
7. Loading states shown while fetching data

## Tasks / Subtasks

- [ ] Create dashboard page `app/dashboard/page.tsx` (AC: 1)
  - [ ] Create Server Component for data fetching
  - [ ] Add page metadata: title "Dashboard - Interlinear"
  - [ ] Fetch user profile from Supabase
  - [ ] Fetch courses matching user level
  - [ ] Pass data to client components

- [ ] Create dashboard layout component (AC: 2, 6)
  - [ ] Create `components/dashboard/DashboardLayout.tsx`
  - [ ] Layout structure:
    ```
    Header
      â”œâ”€ Welcome message ("Welcome back, [name]!")
      â””â”€ Stats widgets (XP, Streak, Level)
    Course Section
      â”œâ”€ Section title ("Your Courses")
      â””â”€ Course grid (CourseCard components)
    ```
  - [ ] Use CSS Grid: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`
  - [ ] Mobile: vertical stack, desktop: horizontal grid

- [ ] Create stats widgets (AC: 2)
  - [ ] Create `components/dashboard/StatsWidget.tsx`
  - [ ] XP widget:
    - [ ] Display current XP
    - [ ] Progress bar to next level (e.g., "450 / 1000 XP")
  - [ ] Streak widget:
    - [ ] Display current streak count
    - [ ] Fire emoji + number: "ðŸ”¥ 7 day streak"
  - [ ] Level widget:
    - [ ] Display current level (A1, A2, B1, etc.)
    - [ ] Badge style: colored pill

- [ ] Fetch user profile data (AC: 2)
  - [ ] Create service `lib/services/profile.ts`:
    ```typescript
    export async function getUserProfile(userId: string) {
      const supabase = createClient();
      const { data, error } = await supabase
        .from('user_profiles')
        .select('xp, streak, level, last_activity_date')
        .eq('user_id', userId)
        .single();

      if (error) throw error;
      return data;
    }
    ```
  - [ ] Call from dashboard page Server Component

- [ ] Fetch courses data (AC: 3, 4)
  - [ ] Create service `lib/services/courses.ts`:
    ```typescript
    export async function getCoursesByLevel(level: string, userId: string) {
      const supabase = createClient();

      // Get courses for user's level
      const { data: courses, error } = await supabase
        .from('courses')
        .select(`
          *,
          lessons (id, xp_value)
        `)
        .eq('level', level);

      if (error) throw error;

      // Get user's lesson completions for progress
      const { data: completions } = await supabase
        .from('lesson_completions')
        .select('lesson_id')
        .eq('user_id', userId);

      const completedLessonIds = completions?.map(c => c.lesson_id) || [];

      // Calculate progress for each course
      return courses.map(course => ({
        ...course,
        totalLessons: course.lessons.length,
        completedLessons: course.lessons.filter(l =>
          completedLessonIds.includes(l.id)
        ).length
      }));
    }
    ```

- [ ] Render course cards (AC: 4, 5)
  - [ ] Use existing `CourseCard` component (Story 3.5)
  - [ ] Map courses to CourseCard:
    ```tsx
    {courses.map(course => (
      <CourseCard
        key={course.id}
        course={course}
        progress={course.completedLessons / course.totalLessons}
        showContinue={course.id === lastActiveCourseId}
      />
    ))}
    ```
  - [ ] Determine last active course from most recent lesson completion

- [ ] Add loading states (AC: 7)
  - [ ] Create `components/dashboard/DashboardSkeleton.tsx`
  - [ ] Show skeleton while Server Component loads
  - [ ] Skeleton structure:
    - [ ] 3 placeholder stat widgets
    - [ ] 3 placeholder course cards
  - [ ] Use Suspense boundary:
    ```tsx
    <Suspense fallback={<DashboardSkeleton />}>
      <DashboardContent />
    </Suspense>
    ```

- [ ] Test dashboard (AC: 1-7)
  - [ ] Login as test user
  - [ ] Verify stats widgets show correct data
  - [ ] Verify courses display for user's level
  - [ ] Complete one lesson, refresh, verify progress updates
  - [ ] Test mobile view (resize to 375px width)
  - [ ] Test loading state (throttle network in DevTools)

## Dev Notes

### Dashboard Layout Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Welcome back, Juan!                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚ XP  â”‚ â”‚ðŸ”¥ 7 â”‚ â”‚ A1  â”‚            â”‚
â”‚ â”‚ 450 â”‚ â”‚Streakâ”‚ â”‚Levelâ”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Your Courses                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚Courseâ”‚ â”‚Courseâ”‚ â”‚Courseâ”‚         â”‚
â”‚ â”‚  1   â”‚ â”‚  2   â”‚ â”‚  3   â”‚         â”‚
â”‚ â”‚[===] â”‚ â”‚[====]â”‚ â”‚[=   ]â”‚         â”‚
â”‚ â”‚Continueâ”‚      â”‚      â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### XP Level Thresholds
Define XP requirements for levels:
```typescript
const XP_THRESHOLDS = {
  A1: 0,
  A2: 1000,
  B1: 2500,
  B2: 5000,
  C1: 10000,
  C2: 20000
};

function getNextLevelXP(currentLevel: string): number {
  const levels = Object.keys(XP_THRESHOLDS);
  const currentIndex = levels.indexOf(currentLevel);
  return XP_THRESHOLDS[levels[currentIndex + 1]] || 0;
}
```

### Course Filtering Logic
- User at A1 level â†’ Show A1 courses only
- User at A2 level â†’ Show A2 courses (optionally A1 for review)
- Option to "Browse All Levels" for advanced users

### Last Active Course
Determine from most recent `lesson_completions.completed_at`:
```sql
SELECT course_id
FROM lesson_completions lc
JOIN lessons l ON lc.lesson_id = l.id
WHERE lc.user_id = $1
ORDER BY lc.completed_at DESC
LIMIT 1;
```

### Source Tree
```
app/
  dashboard/
    page.tsx              # New dashboard page
components/
  dashboard/              # New directory
    DashboardLayout.tsx   # Layout wrapper
    StatsWidget.tsx       # XP/Streak/Level widgets
    DashboardSkeleton.tsx # Loading state
  courses/
    CourseCard.tsx        # From Story 3.5
lib/
  services/
    profile.ts            # New profile service
    courses.ts            # New courses service
```

### Testing

**Test File Location:**
- `app/dashboard/page.test.tsx`
- `components/dashboard/StatsWidget.test.tsx`

**Unit Tests:**
```typescript
describe('Dashboard Page', () => {
  it('displays user stats widgets', async () => {
    const mockProfile = { xp: 450, streak: 7, level: 'A1' };
    render(<Dashboard profile={mockProfile} courses={[]} />);

    expect(screen.getByText('450')).toBeInTheDocument();
    expect(screen.getByText('ðŸ”¥ 7')).toBeInTheDocument();
    expect(screen.getByText('A1')).toBeInTheDocument();
  });

  it('displays courses for user level', async () => {
    const mockCourses = [
      { id: '1', title: 'Spanish A1 Course', level: 'A1', completedLessons: 2, totalLessons: 10 }
    ];
    render(<Dashboard profile={{level: 'A1'}} courses={mockCourses} />);

    expect(screen.getByText('Spanish A1 Course')).toBeInTheDocument();
  });

  it('shows Continue button on last active course', async () => {
    const mockCourses = [
      { id: '1', title: 'Course 1', isLastActive: true },
      { id: '2', title: 'Course 2', isLastActive: false }
    ];
    render(<Dashboard courses={mockCourses} />);

    const continueButtons = screen.getAllByText('Continue Learning');
    expect(continueButtons).toHaveLength(1);
  });
});
```

**Integration Tests:**
1. Fetch user profile from Supabase
2. Fetch courses for user level
3. Render dashboard with real data
4. Verify all stats display correctly
5. Click course card, verify navigation to `/courses/[id]`

**E2E Tests:** `tests/e2e/dashboard.spec.ts`
```typescript
test('dashboard displays user progress', async ({ page }) => {
  await page.goto('/login');
  await page.fill('[name="email"]', 'test@example.com');
  await page.fill('[name="password"]', 'password');
  await page.click('button[type="submit"]');

  await expect(page).toHaveURL('/dashboard');
  await expect(page.locator('text=450 XP')).toBeVisible();
  await expect(page.locator('text=ðŸ”¥ 7')).toBeVisible();
  await expect(page.locator('text=Spanish A1 Course')).toBeVisible();
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
