# Story 4.1: Exercise Validation API

## Status
Draft

## Story
**As a** developer,
**I want** a server-side exercise validation API,
**so that** exercise answers are validated securely without client-side tampering.

## Acceptance Criteria
1. POST `/api/exercises/[id]/validate` route created
2. Route accepts `user_answer` in request body
3. Route validates answer against exercise.answer (case-insensitive, trimmed)
4. Route awards partial XP (10 XP) on correct answer
5. Route records exercise attempt in database
6. Route returns: `is_correct`, `correct_answer` (if wrong), `xp_earned`, `new_total_xp`
7. Route requires authentication
8. Route handles errors gracefully

## Tasks / Subtasks

- [ ] Create validation route `app/api/exercises/[id]/validate/route.ts` (AC: 1, 2, 7)
  - [ ] Define POST handler
  - [ ] Get exercise ID from params: `params.id`
  - [ ] Parse request body: `{ user_answer }`
  - [ ] Check authentication: `supabase.auth.getSession()`
  - [ ] Return 401 if not authenticated

- [ ] Fetch exercise data (AC: 3)
  - [ ] Query exercises table:
    ```typescript
    const { data: exercise } = await supabase
      .from('exercises')
      .select('answer, xp_value, lesson_id')
      .eq('id', params.id)
      .single();
    ```
  - [ ] Return 404 if exercise not found

- [ ] Validate answer (AC: 3)
  - [ ] Normalize both answers:
    ```typescript
    const userAnswerNormalized = user_answer.trim().toLowerCase();
    const correctAnswerNormalized = exercise.answer.trim().toLowerCase();
    const is_correct = userAnswerNormalized === correctAnswerNormalized;
    ```
  - [ ] Set `xp_earned = is_correct ? exercise.xp_value : 0`

- [ ] Record attempt (AC: 5)
  - [ ] Insert into exercise_attempts:
    ```typescript
    const { error: attemptError } = await supabase
      .from('exercise_attempts')
      .insert({
        user_id: session.user.id,
        exercise_id: params.id,
        user_answer,
        is_correct,
        xp_earned,
        attempted_at: new Date().toISOString()
      });
    ```

- [ ] Award XP (AC: 4)
  - [ ] Query current user XP:
    ```typescript
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('xp, last_activity_date')
      .eq('user_id', session.user.id)
      .single();
    ```
  - [ ] Calculate new XP: `new_total_xp = profile.xp + xp_earned`
  - [ ] Update user profile:
    ```typescript
    await supabase
      .from('user_profiles')
      .update({
        xp: new_total_xp,
        last_activity_date: new Date().toISOString()
      })
      .eq('user_id', session.user.id);
    ```

- [ ] Return response (AC: 6)
  - [ ] Return JSON:
    ```typescript
    return NextResponse.json({
      is_correct,
      correct_answer: is_correct ? undefined : exercise.answer,
      xp_earned,
      new_total_xp,
      attempt_id: attemptData.id
    });
    ```

- [ ] Add error handling (AC: 8)
  - [ ] Wrap in try-catch
  - [ ] Return 400 for validation errors
  - [ ] Return 500 for database errors
  - [ ] Log errors with context

- [ ] Test API route (AC: 1-8)
  - [ ] Test correct answer → returns is_correct=true, awards XP
  - [ ] Test incorrect answer → returns is_correct=false, correct_answer shown
  - [ ] Test case insensitivity ("Soy" === "soy")
  - [ ] Test whitespace trimming (" soy " === "soy")
  - [ ] Test unauthenticated request → 401
  - [ ] Test invalid exercise ID → 404

## Dev Notes

### Validation Logic
**Case-Insensitive Matching:**
```typescript
const isCorrect = (userAnswer: string, correctAnswer: string): boolean => {
  return userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
};
```

**Future Enhancement:** Fuzzy matching for minor typos using Levenshtein distance.

### XP Award Strategy
- **Partial XP:** 10 XP per correct exercise (immediate feedback)
- **Bulk XP:** 100 XP on lesson completion (Story 5.x)
- **No XP on Retry:** Only first correct attempt awards XP

### Attempt Tracking
All attempts recorded (correct + incorrect) for analytics:
```sql
SELECT
  COUNT(*) as total_attempts,
  SUM(CASE WHEN is_correct THEN 1 ELSE 0 END) as correct_attempts
FROM exercise_attempts
WHERE user_id = $1 AND exercise_id = $2;
```

### Activity Tracking
Update `last_activity_date` on every exercise attempt for streak calculation.

### Source Tree
```
app/
  api/
    exercises/
      [id]/
        validate/
          route.ts        # New validation API
```

### Testing

**Test File Location:** `app/api/exercises/[id]/validate/route.test.ts`

**Unit Tests:**
```typescript
describe('POST /api/exercises/[id]/validate', () => {
  it('validates correct answer and awards XP', async () => {
    const request = new Request('http://localhost/api/exercises/123/validate', {
      method: 'POST',
      body: JSON.stringify({ user_answer: 'soy' })
    });

    const response = await POST(request, { params: { id: '123' } });
    const data = await response.json();

    expect(data.is_correct).toBe(true);
    expect(data.xp_earned).toBe(10);
    expect(data.new_total_xp).toBeGreaterThan(0);
  });

  it('returns correct answer on incorrect submission', async () => {
    const request = new Request('http://localhost/api/exercises/123/validate', {
      method: 'POST',
      body: JSON.stringify({ user_answer: 'wrong' })
    });

    const response = await POST(request, { params: { id: '123' } });
    const data = await response.json();

    expect(data.is_correct).toBe(false);
    expect(data.correct_answer).toBe('soy');
    expect(data.xp_earned).toBe(0);
  });
});
```

**E2E Tests:** Covered by exercise component tests (Story 4.2-4.3).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story | Bob |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
