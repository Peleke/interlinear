# Story 2.3: Onboarding API Routes

## Status
Completed

## Story
**As a** developer,
**I want** API routes for onboarding assessment and profile creation,
**so that** the system can evaluate user level and persist onboarding data.

## Acceptance Criteria
1. POST `/api/onboarding/assess` route created
2. Route accepts `conversation`, `goals`, `timezone` in request body
3. Route analyzes conversation with OpenAI to determine level (A1, A2, B1)
4. Route returns `assessed_level` and `recommended_course_id`
5. POST `/api/onboarding/complete` route created
6. Route creates user profile with assessed level, goals, timezone, onboarding_completed=true
7. Route returns created user profile
8. Both routes require authentication (Supabase session)
9. Routes handle errors gracefully with clear error messages

## Tasks / Subtasks

- [ ] Create `/api/onboarding/assess/route.ts` (AC: 1, 2, 3, 4, 8, 9)
  - [ ] Define POST handler with request validation
  - [ ] Parse request body: `{ conversation, goals, timezone }`
  - [ ] Validate required fields (conversation array, goals array)
  - [ ] Check authentication: `const { data: { session } } = await supabase.auth.getSession()`
  - [ ] Return 401 if not authenticated

- [ ] Implement level assessment logic (AC: 3)
  - [ ] Send conversation to OpenAI with analysis prompt:
    ```typescript
    const analysisPrompt = `
    Analyze this Spanish conversation and determine the user's proficiency level.

    Conversation:
    ${conversation.map(m => `${m.role}: ${m.content}`).join('\n')}

    Evaluate:
    - Grammar accuracy (verb conjugations, articles, gender agreement)
    - Vocabulary range (basic vs. intermediate words)
    - Sentence complexity (fragments, simple, compound)

    Return ONLY the level: A1, A2, or B1
    `;
    ```
  - [ ] Call OpenAI API with analysis prompt
  - [ ] Parse response to extract level (A1/A2/B1)
  - [ ] Validate level is one of allowed values

- [ ] Determine recommended course (AC: 4)
  - [ ] Query Supabase for course matching assessed level:
    ```typescript
    const { data: course } = await supabase
      .from('courses')
      .select('id')
      .eq('level', assessed_level)
      .single();
    ```
  - [ ] Return course ID with level:
    ```typescript
    return NextResponse.json({
      assessed_level,
      recommended_course_id: course.id
    });
    ```

- [ ] Create `/api/onboarding/complete/route.ts` (AC: 5, 6, 7, 8, 9)
  - [ ] Define POST handler
  - [ ] Parse request: `{ assessed_level, goals, timezone }`
  - [ ] Check authentication
  - [ ] Validate user doesn't already have profile:
    ```typescript
    const { data: existing } = await supabase
      .from('user_profiles')
      .select('user_id')
      .eq('user_id', session.user.id)
      .single();

    if (existing) {
      return NextResponse.json({ error: 'Profile already exists' }, { status: 400 });
    }
    ```

- [ ] Create user profile (AC: 6)
  - [ ] Insert into `user_profiles`:
    ```typescript
    const { data: profile, error } = await supabase
      .from('user_profiles')
      .insert({
        user_id: session.user.id,
        level: assessed_level,
        assessed_level,
        goals,
        timezone,
        onboarding_completed: true,
        xp: 0,
        streak: 0
      })
      .select()
      .single();
    ```
  - [ ] Return profile: `NextResponse.json({ profile })`

- [ ] Add error handling (AC: 9)
  - [ ] Wrap all operations in try-catch
  - [ ] Return structured errors:
    ```typescript
    return NextResponse.json({
      error: {
        code: 'VALIDATION_ERROR',
        message: 'Missing required field: goals',
        timestamp: new Date().toISOString()
      }
    }, { status: 400 });
    ```
  - [ ] Log errors to console with context

- [ ] Test API routes (AC: 1-9)
  - [ ] Test assess route:
    - [ ] Valid request with conversation → returns level + course_id
    - [ ] Missing conversation → 400 error
    - [ ] Unauthenticated → 401 error
  - [ ] Test complete route:
    - [ ] Valid request → creates profile, returns profile
    - [ ] Duplicate profile → 400 error
    - [ ] Missing timezone → 400 error

## Dev Notes

### API Route Structure
```typescript
// app/api/onboarding/assess/route.ts
import { createClient } from '@/lib/supabase/server';
import { NextRequest, NextResponse } from 'next/server';
import { getChatCompletion } from '@/lib/tutor-tools';

export async function POST(request: NextRequest) {
  try {
    const supabase = createClient();
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { conversation, goals, timezone } = await request.json();

    // Assessment logic...

    return NextResponse.json({ assessed_level, recommended_course_id });
  } catch (error) {
    console.error('Onboarding assessment error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

### OpenAI Integration
Reuse existing `getChatCompletion` from `/lib/tutor-tools.ts`:
```typescript
const response = await getChatCompletion([
  { role: 'system', content: analysisPrompt },
  { role: 'user', content: 'Analyze the conversation above' }
]);

const assessed_level = response.content.trim(); // "A1", "A2", or "B1"
```

### Level Determination Logic
**OpenAI Analysis Criteria:**
- **A1:** Basic vocabulary, present tense only, simple sentences, common errors
- **A2:** Expanded vocabulary, some past/future tense, longer sentences, fewer errors
- **B1:** Advanced vocabulary, multiple tenses, complex sentences, minimal errors

**Fallback:** If OpenAI returns unclear response, default to A1 (safest beginner level)

### Course Recommendation
- A1 level → "Spanish A1 Course"
- A2 level → "Spanish A2 Course"
- B1 level → "Spanish B1 Course"

Assumes one course per level exists in database (seeded by Story 1.3).

### Request/Response Schemas

**POST `/api/onboarding/assess`**
```typescript
// Request
{
  conversation: Array<{ role: 'user' | 'assistant', content: string }>;
  goals: string[];
  timezone: string; // IANA timezone
}

// Response
{
  assessed_level: 'A1' | 'A2' | 'B1';
  recommended_course_id: string; // UUID
}
```

**POST `/api/onboarding/complete`**
```typescript
// Request
{
  assessed_level: string;
  goals: string[];
  timezone: string;
}

// Response
{
  profile: UserProfile;
}
```

### Source Tree
```
app/
  api/
    onboarding/
      assess/
        route.ts          # New assessment API
      complete/
        route.ts          # New profile creation API
lib/
  tutor-tools.ts          # Existing (reuse getChatCompletion)
```

### Testing

**Test File Location:**
- `app/api/onboarding/assess/route.test.ts`
- `app/api/onboarding/complete/route.test.ts`

**Unit Tests:**
```typescript
import { POST } from './route';
import { createClient } from '@/lib/supabase/server';

vi.mock('@/lib/supabase/server');
vi.mock('@/lib/tutor-tools');

describe('POST /api/onboarding/assess', () => {
  it('returns assessed level and course ID', async () => {
    const mockSupabase = {
      auth: { getSession: vi.fn().mockResolvedValue({
        data: { session: { user: { id: 'user123' } } }
      })},
      from: vi.fn(() => ({
        select: vi.fn(() => ({
          eq: vi.fn(() => ({
            single: vi.fn().mockResolvedValue({
              data: { id: 'course-a1-id' }
            })
          }))
        }))
      }))
    };

    vi.mocked(createClient).mockReturnValue(mockSupabase as any);
    vi.mocked(getChatCompletion).mockResolvedValue({ content: 'A1' });

    const request = new Request('http://localhost/api/onboarding/assess', {
      method: 'POST',
      body: JSON.stringify({
        conversation: [{ role: 'user', content: 'Hola' }],
        goals: ['travel'],
        timezone: 'America/New_York'
      })
    });

    const response = await POST(request);
    const data = await response.json();

    expect(data.assessed_level).toBe('A1');
    expect(data.recommended_course_id).toBe('course-a1-id');
  });

  it('returns 401 for unauthenticated request', async () => {
    const mockSupabase = {
      auth: { getSession: vi.fn().mockResolvedValue({ data: { session: null } }) }
    };

    vi.mocked(createClient).mockReturnValue(mockSupabase as any);

    const request = new Request('http://localhost/api/onboarding/assess', {
      method: 'POST',
      body: JSON.stringify({})
    });

    const response = await POST(request);
    expect(response.status).toBe(401);
  });
});
```

**Integration Tests:**
Test with real Supabase instance (staging):
1. Authenticate as test user
2. POST to `/api/onboarding/assess` with sample conversation
3. Verify response contains valid level and course_id
4. POST to `/api/onboarding/complete` with assessed data
5. Verify profile created in database

**E2E Tests:**
Covered by onboarding flow E2E test (Story 2.2).

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
