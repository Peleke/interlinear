# Story 3.6: Auto-Enrollment System

## Status
Draft

## Story
**As a** learner,
**I want** to be automatically enrolled in a course when I start my first lesson,
**so that** I can seamlessly begin learning without extra enrollment steps.

## Acceptance Criteria
1. `course_enrollments` table created with RLS policies
2. First lesson click triggers auto-enrollment in parent course
3. Dashboard shows only lessons from enrolled courses
4. Course detail page shows enrollment status
5. Enrolled courses display "Continue Learning" badge
6. Unenrolled courses display "Start Learning" badge
7. Enrollment timestamp tracked for analytics
8. User can view all enrolled courses on dashboard

## Tasks / Subtasks

- [ ] Create course_enrollments table migration (AC: 1)
  - [ ] Create migration `supabase/migrations/20251102_course_enrollments.sql`
  - [ ] Table schema:
    ```sql
    CREATE TABLE course_enrollments (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
      course_id UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
      enrolled_at TIMESTAMPTZ DEFAULT NOW(),
      UNIQUE(user_id, course_id)
    );

    CREATE INDEX idx_course_enrollments_user ON course_enrollments(user_id);
    CREATE INDEX idx_course_enrollments_course ON course_enrollments(course_id);
    ```
  - [ ] Add RLS policies:
    ```sql
    ALTER TABLE course_enrollments ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Users can view own enrollments"
      ON course_enrollments FOR SELECT
      USING (auth.uid() = user_id);

    CREATE POLICY "Users can enroll themselves"
      ON course_enrollments FOR INSERT
      WITH CHECK (auth.uid() = user_id);
    ```

- [ ] Create auto-enrollment API route (AC: 2)
  - [ ] Create `app/api/courses/enroll/route.ts`
  - [ ] Accept POST with `{ courseId: string }`
  - [ ] Insert enrollment record (upsert to handle duplicates)
  - [ ] Return success response
  - [ ] Code:
    ```typescript
    export async function POST(request: Request) {
      const { courseId } = await request.json();
      const supabase = createClient();

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });

      const { data, error } = await supabase
        .from('course_enrollments')
        .upsert({
          user_id: user.id,
          course_id: courseId
        }, {
          onConflict: 'user_id,course_id'
        })
        .select()
        .single();

      if (error) return NextResponse.json({ error: error.message }, { status: 500 });
      return NextResponse.json({ success: true, enrollment: data });
    }
    ```

- [ ] Integrate auto-enrollment in lesson viewer (AC: 2)
  - [ ] Update `app/lessons/[id]/page.tsx`
  - [ ] On page load, fetch lesson's course_id
  - [ ] Check if user enrolled in course
  - [ ] If not enrolled, call `/api/courses/enroll`
  - [ ] Code:
    ```typescript
    useEffect(() => {
      async function ensureEnrollment() {
        const { data: lesson } = await supabase
          .from('lessons')
          .select('course_id')
          .eq('id', lessonId)
          .single();

        const { data: enrollment } = await supabase
          .from('course_enrollments')
          .select('id')
          .eq('user_id', userId)
          .eq('course_id', lesson.course_id)
          .maybeSingle();

        if (!enrollment) {
          await fetch('/api/courses/enroll', {
            method: 'POST',
            body: JSON.stringify({ courseId: lesson.course_id })
          });
        }
      }
      ensureEnrollment();
    }, [lessonId]);
    ```

- [ ] Filter dashboard lessons by enrollment (AC: 3)
  - [ ] Update `lib/services/courses.ts`:
    ```typescript
    export async function getEnrolledCourseLessons(userId: string) {
      const supabase = createClient();
      const { data } = await supabase
        .from('course_enrollments')
        .select(`
          course_id,
          courses (
            id,
            title,
            lessons (*)
          )
        `)
        .eq('user_id', userId);

      return data?.flatMap(e => e.courses.lessons) || [];
    }
    ```
  - [ ] Update dashboard to use `getEnrolledCourseLessons` instead of all lessons

- [ ] Add enrollment badges to course cards (AC: 5, 6)
  - [ ] Update `components/courses/CourseCard.tsx`
  - [ ] Accept `isEnrolled` prop
  - [ ] Render badge:
    ```typescript
    {isEnrolled ? (
      <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">
        Continue Learning
      </span>
    ) : (
      <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
        Start Learning
      </span>
    )}
    ```

- [ ] Update course detail page enrollment display (AC: 4)
  - [ ] Update `app/courses/[id]/page.tsx`
  - [ ] Fetch enrollment status
  - [ ] Display enrollment date if enrolled
  - [ ] Show "You're enrolled" message with timestamp

- [ ] Test auto-enrollment flow (AC: 1-8)
  - [ ] Navigate to lesson without enrollment
  - [ ] Verify auto-enrollment triggers
  - [ ] Check `course_enrollments` table for record
  - [ ] Verify dashboard shows enrolled course lessons
  - [ ] Verify course card shows "Continue Learning" badge
  - [ ] Test enrollment timestamp accuracy
  - [ ] Verify duplicate enrollment prevented (UNIQUE constraint)

## Dev Notes

### Auto-Enrollment Trigger Points
```
User clicks lesson → Lesson page loads → Check enrollment → Auto-enroll if needed
```

### Why Auto-Enroll vs Manual?
- **User Experience**: Reduces friction, no extra clicks
- **Simplicity**: No "Enroll" button needed on course detail page
- **Intent**: Clicking lesson shows clear intent to learn
- **Reversible**: Can add "Unenroll" feature later if needed

### Database Schema
```
course_enrollments
├── id (UUID, PK)
├── user_id (UUID, FK → auth.users)
├── course_id (UUID, FK → courses)
├── enrolled_at (TIMESTAMPTZ)
└── UNIQUE(user_id, course_id)
```

### Analytics Potential
- Track enrollment timestamps for growth metrics
- Measure time-to-first-lesson after signup
- Identify popular courses by enrollment count

### Source Tree
```
supabase/
  migrations/
    20251102_course_enrollments.sql    # New migration
app/
  api/
    courses/
      enroll/
        route.ts                        # New API route
  lessons/
    [id]/
      page.tsx                          # Updated with auto-enroll
  courses/
    [id]/
      page.tsx                          # Updated with enrollment display
components/
  courses/
    CourseCard.tsx                      # Updated with badges
lib/
  services/
    courses.ts                          # Updated with enrollment filtering
```

### Testing

**Test File Location:** `tests/e2e/course-enrollment.spec.ts`

**E2E Tests:**
```typescript
test('auto-enrolls user when clicking first lesson', async ({ page }) => {
  await page.goto('/courses/course-1');

  // Verify not enrolled initially
  await expect(page.locator('text=Start Learning')).toBeVisible();

  // Click first lesson
  await page.click('text=Lesson 1');
  await expect(page).toHaveURL(/\/lessons\/.+/);

  // Go back to course page
  await page.goto('/courses/course-1');

  // Verify now enrolled
  await expect(page.locator('text=Continue Learning')).toBeVisible();
  await expect(page.locator('text=Enrolled')).toBeVisible();
});

test('dashboard shows only enrolled course lessons', async ({ page }) => {
  // Enroll in course 1 by visiting lesson
  await page.goto('/lessons/lesson-1-id');

  // Navigate to dashboard
  await page.goto('/dashboard');

  // Verify course 1 lessons visible
  await expect(page.locator('text=Course 1: Lesson 1')).toBeVisible();

  // Verify course 2 lessons NOT visible (not enrolled)
  await expect(page.locator('text=Course 2: Lesson 1')).not.toBeVisible();
});

test('prevents duplicate enrollments', async ({ page }) => {
  // Click lesson twice
  await page.goto('/lessons/lesson-1-id');
  await page.goto('/lessons/lesson-1-id');

  // Verify only 1 enrollment record created
  // (Backend test: check database has single record)
});
```

**Unit Tests:** `components/courses/CourseCard.test.tsx`
```typescript
describe('CourseCard enrollment badges', () => {
  it('shows "Continue Learning" for enrolled courses', () => {
    render(<CourseCard course={mockCourse} isEnrolled={true} />);
    expect(screen.getByText('Continue Learning')).toBeInTheDocument();
  });

  it('shows "Start Learning" for unenrolled courses', () => {
    render(<CourseCard course={mockCourse} isEnrolled={false} />);
    expect(screen.getByText('Start Learning')).toBeInTheDocument();
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story creation | Claude (per user request) |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
