# Story 3.4: Lesson Viewer Page

## Status
Draft

## Story
**As a** learner,
**I want** to view lesson content with grammar explanations and vocabulary,
**so that** I can learn new concepts before practicing with exercises.

## Acceptance Criteria
1. `/lessons/[id]` page created (protected route)
2. Page displays lesson title and overview
3. Lesson content rendered as Markdown with proper formatting
4. Grammar points section shows name, overview, and examples
5. Vocabulary section shows word/translation table
6. "Complete Lesson" button appears at bottom (disabled if exercises incomplete)
7. Mobile-responsive layout with readable typography
8. Links to practice with reader/tutor at bottom

## Tasks / Subtasks

- [ ] Create lesson viewer page `app/lessons/[id]/page.tsx` (AC: 1, 2)
  - [ ] Get lesson ID from params
  - [ ] Fetch lesson with grammar points, vocabulary, exercises
  - [ ] Pass data to content component

- [ ] Create lesson content component (AC: 2, 3, 7)
  - [ ] Create `components/lessons/LessonContent.tsx`
  - [ ] Render lesson title and overview
  - [ ] Parse and render Markdown from `grammar_content.markdown`
  - [ ] Use `marked` library for Markdown parsing
  - [ ] Apply typography styles: headings, paragraphs, lists

- [ ] Create grammar section component (AC: 4)
  - [ ] Create `components/lessons/GrammarSection.tsx`
  - [ ] Display each grammar point:
    - [ ] Name (heading)
    - [ ] Overview (paragraph)
    - [ ] Examples (bulleted list)

- [ ] Create vocabulary section component (AC: 5)
  - [ ] Create `components/lessons/VocabularySection.tsx`
  - [ ] Render vocabulary as table:
    ```
    | Spanish | English | Example |
    |---------|---------|---------|
    | hola    | hello   | ¡Hola!  |
    ```

- [ ] Add "Complete Lesson" button (AC: 6)
  - [ ] Check if all exercises completed:
    ```typescript
    const allExercisesComplete = exercises.every(ex =>
      exerciseAttempts.some(att => att.exercise_id === ex.id && att.is_correct)
    );
    ```
  - [ ] Disable button if `!allExercisesComplete`
  - [ ] OnClick: Call `/api/lessons/[id]/complete`

- [ ] Add integration links (AC: 8)
  - [ ] "Practice Reading" → `/reader?lesson=${lessonId}`
  - [ ] "Ask Tutor" → `/tutor?context=lesson&id=${lessonId}`

- [ ] Fetch lesson data (AC: 2-5)
  - [ ] Create `lib/services/lessons.ts`:
    ```typescript
    export async function getLessonById(lessonId: string, userId: string) {
      const { data: lesson } = await supabase
        .from('lessons')
        .select(`
          *,
          lesson_grammar_points (
            grammar_point:grammar_points (*)
          ),
          exercises (*)
        `)
        .eq('id', lessonId)
        .single();

      const { data: attempts } = await supabase
        .from('exercise_attempts')
        .select('exercise_id, is_correct')
        .eq('user_id', userId)
        .in('exercise_id', lesson.exercises.map(e => e.id));

      return { ...lesson, exerciseAttempts: attempts || [] };
    }
    ```

- [ ] Test lesson viewer (AC: 1-8)
  - [ ] Navigate to lesson
  - [ ] Verify Markdown renders correctly
  - [ ] Verify grammar points display
  - [ ] Verify vocabulary table shows
  - [ ] Complete exercises, verify button enables
  - [ ] Click "Complete Lesson", verify success
  - [ ] Test mobile view

## Dev Notes
Use `marked` for Markdown: `npm install marked @types/marked`

Architecture ref: lines 686-695 (GET /api/lessons/[id])

## Testing
**E2E:** View lesson, complete exercises, mark lesson complete, verify XP awarded.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story | Bob |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
