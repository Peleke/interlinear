# Story 1.2: YAML Lesson Parser

## Status
Done

## Story
**As a** content author,
**I want** a YAML-to-database parser script,
**so that** I can author lessons in developer-friendly YAML format and automatically seed them into Supabase.

## Acceptance Criteria
1. Parser script accepts YAML file path as argument and parses front-matter + Markdown content
2. Validates required fields: `id`, `title`, `level`, `xp_value`, `grammar_points`, `vocabulary`, `exercises`
3. Inserts course record if not exists (based on level)
4. Inserts lesson record with parsed metadata and Markdown content in `grammar_content.markdown`
5. Inserts grammar points and creates `lesson_grammar_points` associations
6. Inserts exercises with correct types and answers
7. Handles duplicate inserts gracefully (idempotent operation based on lesson `id`)
8. Provides clear error messages for invalid YAML structure or missing fields
9. Script can be run via `npm run seed:lessons -- lessons/a1/lesson-01.yaml`

## Tasks / Subtasks

- [x] Create parser script `scripts/parse-lessons.ts` (AC: 1, 2)
  - [x] Import dependencies: `gray-matter` for YAML parsing, `@supabase/supabase-js` for DB access
  - [x] Accept file path from command line args: `process.argv[2]`
  - [x] Read file content with `fs.readFileSync`
  - [x] Parse YAML front-matter with `matter(fileContent)`
  - [x] Extract `data` (front-matter) and `content` (Markdown body)
  - [x] Validate required fields exist (AC: 2)
  - [x] Throw descriptive errors if validation fails

- [x] Implement course insertion logic (AC: 3)
  - [x] Query `courses` table for existing course by `level`
  - [x] If not exists, insert course with default title: `"Spanish ${level} Course"`
  - [x] Use `upsert` with `onConflict: 'level'` for idempotency
  - [x] Store `course_id` for lesson insertion

- [x] Implement lesson insertion logic (AC: 4, 7)
  - [x] Map YAML fields to lesson table columns:
    - `id` → custom field (not UUID, use for idempotency)
    - `title` → title
    - `overview` → use first 100 chars of Markdown or default
    - `xp_value` → xp_value
    - `sequence_order` → derive from filename (lesson-01 → 1)
  - [x] Insert lesson with `grammar_content: { markdown: content }`
  - [x] Insert vocabulary array into `vocabulary` JSONB field
  - [x] Use `upsert` with custom `id` field for idempotency (AC: 7)

- [x] Implement grammar points insertion (AC: 5)
  - [x] Loop through `grammar_points` array from YAML
  - [x] For each grammar point:
    - [x] Upsert into `grammar_points` table (on conflict: `name`)
    - [x] Insert into `lesson_grammar_points` junction table
  - [x] Handle array of examples correctly

- [x] Implement exercises insertion (AC: 6)
  - [x] Loop through `exercises` array from YAML
  - [x] For each exercise:
    - [x] Map `type` to enum: 'fill_blank', 'multiple_choice', 'translation'
    - [x] Insert `prompt`, `answer`, `options` (if multiple choice)
    - [x] Default `xp_value` to 10 if not specified
  - [x] Validate exercise type is valid enum value

- [x] Add error handling (AC: 8)
  - [x] Try-catch around DB operations
  - [x] Log clear error messages with context:
    - [x] "Missing required field: grammar_points"
    - [x] "Invalid exercise type: xyz (must be fill_blank, multiple_choice, or translation)"
    - [x] "Database error: [error message]"
  - [x] Exit with non-zero code on failure

- [x] Add npm script (AC: 9)
  - [x] Update `package.json` scripts:
    ```json
    "seed:lessons": "npx tsx scripts/parse-lessons.ts"
    ```
  - [x] Test: `npm run seed:lessons -- lessons/a1/lesson-01.yaml`

- [x] Test parser with sample YAML (AC: 1-9)
  - [x] Create `lessons/test/sample.yaml` with all fields
  - [x] Run parser: `npm run seed:lessons -- lessons/test/sample.yaml`
  - [x] Verify lesson inserted in Supabase
  - [x] Verify grammar points and exercises inserted
  - [x] Run again to test idempotency
  - [x] Test with invalid YAML (missing fields) to verify error handling

## Dev Notes

### YAML Lesson Format Reference
From `docs/architecture-v2-course-system.md` lines 223-240:

```yaml
---
id: lesson_a1_01
title: "Saludos y Presentaciones"
level: A1
xp_value: 100
grammar_points:
  - id: gp_ser_present
    name: "El verbo SER (presente)"
    overview: "The verb 'to be' in present tense"
    examples:
      - "Yo soy estudiante"
      - "Ella es de México"
vocabulary:
  - word: "hola"
    translation: "hello"
    example: "Hola, ¿cómo estás?"
exercises:
  - type: fill_blank
    prompt: "Yo ___ estudiante"
    answer: "soy"
    xp_value: 10
---
# Saludos y Presentaciones

[Markdown lesson content here]
```

### Parser Workflow
1. Read YAML file → Parse front-matter + Markdown body
2. Upsert course by level (get course_id)
3. Upsert lesson with course_id and metadata
4. Upsert grammar points → link to lesson via junction table
5. Insert exercises linked to lesson_id

### Idempotency Strategy
- **Courses:** Upsert by `level` (unique constraint)
- **Lessons:** Use custom `id` field from YAML (not auto-generated UUID)
- **Grammar Points:** Upsert by `name` (unique constraint)
- **Exercises:** Re-insert on each run (delete existing first if needed)

### Dependencies
```json
{
  "gray-matter": "^4.0.3",
  "@supabase/supabase-js": "^2.x"
}
```

### Environment Variables
Parser needs Supabase credentials:
```
NEXT_PUBLIC_SUPABASE_URL
SUPABASE_SERVICE_ROLE_KEY (for write access)
```

### Source Tree
```
scripts/
  parse-lessons.ts        # New parser script
lessons/                  # New directory
  a1/
    lesson-01.yaml
    lesson-02.yaml
  test/
    sample.yaml           # Test fixture
package.json              # Add seed:lessons script
```

### Testing

**Test File Location:** `scripts/parse-lessons.test.ts`

**Unit Tests:**
```typescript
describe('YAML Lesson Parser', () => {
  it('parses valid YAML front-matter and Markdown', () => {
    const yaml = `---
id: test_lesson
title: "Test Lesson"
level: A1
---
# Content`;
    const parsed = parseLesson(yaml);
    expect(parsed.data.id).toBe('test_lesson');
    expect(parsed.content).toContain('# Content');
  });

  it('validates required fields', () => {
    const invalidYaml = `---
title: "Missing ID"
---`;
    expect(() => parseLesson(invalidYaml)).toThrow('Missing required field: id');
  });

  it('handles duplicate lesson IDs idempotently', async () => {
    await seedLesson('lessons/test/sample.yaml');
    await seedLesson('lessons/test/sample.yaml'); // Should not error
    const lessons = await supabase.from('lessons').select('*').eq('id', 'test_lesson');
    expect(lessons.data).toHaveLength(1); // Only one record
  });
});
```

**Integration Tests:**
1. Run parser against `lessons/test/sample.yaml`
2. Query Supabase to verify all records inserted
3. Run parser again, verify no duplicates created
4. Verify foreign key relationships intact

**E2E Testing:**
- Not applicable (script is standalone, not part of app flow)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Migration hotfix required: Added UNIQUE constraint to courses.level and changed lessons.id to TEXT type
- Fixed foreign key type mismatches in dependent tables

### Completion Notes
- Created full-featured YAML parser with gray-matter for front-matter parsing
- Implemented idempotent upsert logic for courses, lessons, grammar points
- Exercise deletion/re-insertion strategy for idempotency
- Added dotenv support for loading .env.local
- Supports SERVICE_ROLE_KEY with fallback to ANON_KEY (with warning)
- Sequence order auto-derived from filename pattern (lesson-01.yaml → 1)
- Comprehensive error handling with descriptive messages
- Tested successfully with sample.yaml - all AC verified

### File List
- **Created:** `scripts/parse-lessons.ts`
- **Created:** `lessons/test/sample.yaml`
- **Created:** `supabase/migrations/20251102_course_system_hotfix.sql`
- **Modified:** `package.json` (added seed:lessons script)
- **Modified:** `supabase/migrations/20251102_course_system.sql` (updated for TEXT id and UNIQUE level)

## QA Results
_To be populated by QA agent_
