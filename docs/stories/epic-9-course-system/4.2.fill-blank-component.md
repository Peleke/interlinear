# Story 4.2: Fill-in-Blank Exercise Component

## Status
Draft

## Story
**As a** learner,
**I want** to complete fill-in-blank exercises,
**so that** I can practice Spanish grammar concepts.

## Acceptance Criteria
1. `FillBlankExercise` component created
2. Component displays prompt with blank indicated by `___`
3. Input field captures user answer
4. "Submit" button validates answer via `/api/exercises/[id]/validate`
5. On correct answer: Show success message + XP earned
6. On incorrect answer: Show correct answer + encouragement
7. After submission, disable input and submit button
8. Component handles loading and error states
9. Component is mobile-responsive

## Tasks / Subtasks

- [ ] Create component `components/exercises/FillBlankExercise.tsx` (AC: 1, 2)
  - [ ] Define props interface:
    ```typescript
    interface FillBlankExerciseProps {
      exercise: Exercise;
      onComplete: (isCorrect: boolean, xpEarned: number) => void;
    }
    ```
  - [ ] Use Client Component: `'use client'`
  - [ ] Parse prompt to identify blank position
  - [ ] Render prompt with input field at blank position

- [ ] Implement answer input (AC: 3, 9)
  - [ ] State: `const [userAnswer, setUserAnswer] = useState('')`
  - [ ] Input field:
    ```tsx
    <input
      type="text"
      value={userAnswer}
      onChange={(e) => setUserAnswer(e.target.value)}
      className="border-b-2 border-blue-500 px-2 py-1 text-center"
      placeholder="?"
    />
    ```
  - [ ] Mobile: Full width input on small screens

- [ ] Implement submit logic (AC: 4, 7, 8)
  - [ ] State: `const [result, setResult] = useState<Result | null>(null)`
  - [ ] State: `const [isLoading, setIsLoading] = useState(false)`
  - [ ] OnSubmit:
    ```typescript
    async function handleSubmit() {
      setIsLoading(true);
      try {
        const response = await fetch(`/api/exercises/${exercise.id}/validate`, {
          method: 'POST',
          body: JSON.stringify({ user_answer: userAnswer })
        });
        const data = await response.json();
        setResult(data);
        onComplete(data.is_correct, data.xp_earned);
      } catch (error) {
        console.error('Validation error:', error);
        setError('Failed to validate answer');
      } finally {
        setIsLoading(false);
      }
    }
    ```
  - [ ] Disable input/button after submission: `disabled={result !== null || isLoading}`

- [ ] Show result feedback (AC: 5, 6)
  - [ ] Success message (if correct):
    ```tsx
    <div className="bg-green-50 border-green-300 p-4 rounded">
      ✅ Correct! +{result.xp_earned} XP
    </div>
    ```
  - [ ] Error message (if incorrect):
    ```tsx
    <div className="bg-red-50 border-red-300 p-4 rounded">
      ❌ Not quite. The correct answer is: {result.correct_answer}
      <br />Keep practicing!
    </div>
    ```

- [ ] Add loading state (AC: 8)
  - [ ] Show spinner on submit button while loading:
    ```tsx
    <button disabled={isLoading}>
      {isLoading ? 'Checking...' : 'Submit'}
    </button>
    ```

- [ ] Test component (AC: 1-9)
  - [ ] Render with mock exercise
  - [ ] Type answer, click submit
  - [ ] Verify API called with user_answer
  - [ ] Verify success message on correct answer
  - [ ] Verify error message on incorrect answer
  - [ ] Verify input disabled after submission
  - [ ] Test mobile view

## Dev Notes

### Prompt Parsing
Replace `___` with input field:
```typescript
const parts = exercise.prompt.split('___');
return (
  <>
    {parts[0]}
    <input value={userAnswer} onChange={...} />
    {parts[1]}
  </>
);
```

### UX Enhancements
- **Autofocus:** Focus input on mount for keyboard users
- **Enter Key:** Submit on Enter key press
- **Inline Validation:** Show real-time character count (optional)

### Source Tree
```
components/
  exercises/
    FillBlankExercise.tsx     # New component
    ExerciseResult.tsx        # Shared result display (Story 4.4)
```

### Testing

**Test File Location:** `components/exercises/FillBlankExercise.test.tsx`

**Unit Tests:**
```typescript
describe('FillBlankExercise', () => {
  it('renders prompt with input field', () => {
    const exercise = {
      id: '1',
      type: 'fill_blank',
      prompt: 'Yo ___ estudiante',
      answer: 'soy'
    };
    render(<FillBlankExercise exercise={exercise} onComplete={vi.fn()} />);

    expect(screen.getByText('Yo')).toBeInTheDocument();
    expect(screen.getByText('estudiante')).toBeInTheDocument();
    expect(screen.getByRole('textbox')).toBeInTheDocument();
  });

  it('validates answer on submit', async () => {
    global.fetch = vi.fn().mockResolvedValue({
      json: async () => ({ is_correct: true, xp_earned: 10 })
    });

    render(<FillBlankExercise exercise={{...}} onComplete={vi.fn()} />);

    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: 'soy' } });
    fireEvent.click(screen.getByText('Submit'));

    await waitFor(() => {
      expect(screen.getByText(/Correct/)).toBeInTheDocument();
    });
  });
});
```

**E2E Tests:** Covered by lesson completion flow.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-02 | 1.0 | Initial story | Bob |

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
