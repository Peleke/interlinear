# Story 10.4: End Dialog & Error Collection

**Epic:** Dialog Roleplay Tutor
**Priority:** High
**Effort:** 1 hour
**Dependencies:** Story 10.3 (Conversation Loop)

---

## User Story

**As a** student
**I want to** end the roleplay session
**So that** I can review my performance and errors

---

## Acceptance Criteria

- [ ] "Terminar Diálogo" button visible during active session
- [ ] Clicking button shows confirmation modal
- [ ] Confirmation ends session immediately
- [ ] All errors collected from per-turn corrections
- [ ] Session marked as completed in database
- [ ] UI transitions to review stage (loading spinner during transition)

---

## Technical Tasks

1. Update `DialogRoleplayPanel.tsx`
   - Add "Terminar Diálogo" button to active stage
   - Show confirmation modal on click
   - Handle end session flow
   - Collect errors from message history
   - Transition to review stage

2. Create confirmation modal
   - Warning: "Are you sure? You have N more turns to practice."
   - Buttons: "Keep Practicing" / "End & Review"

3. Error collection logic
   - Iterate through all messages with corrections
   - Extract errors from `correction.errors` array
   - Format for review API

4. Database update
   - Update `tutor_sessions.completed_at` timestamp
   - No changes to dialog_turns (already saved)

---

## UI Flow

```
Active Session:
┌─────────────────────────────────────┐
│  [Conversation history...]          │
│  [Input field]                      │
│  [Send] [Terminar Diálogo] ←        │
└─────────────────────────────────────┘
         ↓ (click)

Confirmation Modal:
┌─────────────────────────────────────┐
│  End Dialog Practice?               │
│                                     │
│  You have 5 more turns to practice. │
│  Are you sure you want to end now?  │
│                                     │
│  [Keep Practicing] [End & Review]   │
└─────────────────────────────────────┘
         ↓ (End & Review)

Loading:
┌─────────────────────────────────────┐
│  Analyzing your performance...      │
│  [Spinner]                          │
└─────────────────────────────────────┘
         ↓

Review Stage (Story 10.5)
```

---

## Error Collection Format

```typescript
const collectedErrors: ErrorAnalysis[] = messages
  .filter(msg => msg.role === 'user' && msg.correction?.hasErrors)
  .flatMap(msg =>
    msg.correction!.errors.map(err => ({
      turn: msg.turnNumber,
      errorText: err.errorText,
      correction: err.correction,
      explanation: err.explanation,
      category: err.category
    }))
  )
```

---

## Test Cases

1. **Confirmation shown:** Click "Terminar Diálogo" → modal appears
2. **Keep practicing:** Click "Keep Practicing" → modal closes, session continues
3. **End session:** Click "End & Review" → session ends, transitions to review
4. **Error collection:** All errors from turns collected correctly
5. **Database update:** `completed_at` timestamp set
6. **Loading state:** Spinner shown during review generation

---

## Definition of Done

- [ ] "Terminar Diálogo" button implemented
- [ ] Confirmation modal works
- [ ] Error collection logic correct
- [ ] Database updates properly
- [ ] Smooth transition to review stage
- [ ] All acceptance criteria met
- [ ] Manual testing complete
