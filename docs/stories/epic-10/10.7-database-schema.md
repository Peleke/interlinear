# Story 10.7: Database Schema Extensions

**Epic:** Dialog Roleplay Tutor
**Priority:** Critical (Blocker)
**Effort:** 1 hour
**Dependencies:** None

---

## User Story

**As a** developer
**I want to** extend the database schema
**So that** dialog roleplay sessions are properly tracked

---

## Acceptance Criteria

- [ ] `tutor_sessions.dialog_id` column added (UUID, nullable)
- [ ] `tutor_sessions.selected_role` column added (TEXT, nullable)
- [ ] Migration script created and tested
- [ ] Foreign key constraint to `lesson_dialogs` table
- [ ] Indexes added for performance
- [ ] Migration documented

---

## Technical Tasks

1. Create migration file
   - File: `supabase/migrations/YYYYMMDD_dialog_roleplay_schema.sql`
   - Use current date in filename

2. Write SQL for schema changes
   - Add new columns to `tutor_sessions`
   - Add foreign key constraint
   - Create indexes for query optimization
   - Add comments for documentation

3. Test migration locally
   - Run migration in local Supabase instance
   - Verify columns exist
   - Test foreign key constraint
   - Verify indexes created

4. Update TypeScript types
   - Update `types/tutor.ts` if needed
   - Ensure type safety

---

## Migration SQL

```sql
-- ============================================================================
-- DIALOG ROLEPLAY TUTOR: Database Schema Extensions
-- ============================================================================
-- Extends tutor_sessions table to support dialog roleplay functionality
-- ============================================================================

-- Add dialog_id column (nullable for backward compatibility)
ALTER TABLE tutor_sessions
ADD COLUMN dialog_id UUID REFERENCES lesson_dialogs(id) ON DELETE CASCADE;

-- Add selected_role column (stores which character the user is playing)
ALTER TABLE tutor_sessions
ADD COLUMN selected_role TEXT;

-- Add comment for documentation
COMMENT ON COLUMN tutor_sessions.dialog_id IS 'References the lesson dialog being practiced (NULL for library text sessions)';
COMMENT ON COLUMN tutor_sessions.selected_role IS 'The character name the user chose to play (e.g., "Mar√≠a", "Carlos")';

-- Create index for performance (querying roleplay sessions by dialog)
CREATE INDEX idx_tutor_sessions_dialog_id ON tutor_sessions(dialog_id) WHERE dialog_id IS NOT NULL;

-- Create index for querying user's roleplay sessions
CREATE INDEX idx_tutor_sessions_user_dialog ON tutor_sessions(user_id, dialog_id) WHERE dialog_id IS NOT NULL;

-- Verify the changes
DO $$
BEGIN
  -- Check if columns exist
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'tutor_sessions' AND column_name = 'dialog_id'
  ) THEN
    RAISE EXCEPTION 'Migration failed: dialog_id column not created';
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'tutor_sessions' AND column_name = 'selected_role'
  ) THEN
    RAISE EXCEPTION 'Migration failed: selected_role column not created';
  END IF;

  RAISE NOTICE 'Dialog roleplay schema migration completed successfully';
END $$;
```

---

## Updated Schema

```sql
CREATE TABLE tutor_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  text_id UUID REFERENCES library_texts(id),          -- Nullable (for library text sessions)
  dialog_id UUID REFERENCES lesson_dialogs(id),       -- NEW: For roleplay sessions
  level TEXT CHECK (level IN ('A1', 'A2', 'B1', 'B2', 'C1', 'C2')) NOT NULL,
  selected_role TEXT,                                  -- NEW: Character user is playing
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);
```

---

## Rollback Plan

```sql
-- If migration needs to be rolled back
ALTER TABLE tutor_sessions DROP COLUMN IF EXISTS dialog_id;
ALTER TABLE tutor_sessions DROP COLUMN IF EXISTS selected_role;
DROP INDEX IF EXISTS idx_tutor_sessions_dialog_id;
DROP INDEX IF EXISTS idx_tutor_sessions_user_dialog;
```

---

## Query Examples

```sql
-- Find all roleplay sessions for a user
SELECT * FROM tutor_sessions
WHERE user_id = $1 AND dialog_id IS NOT NULL
ORDER BY created_at DESC;

-- Find roleplay sessions for a specific dialog
SELECT ts.*, u.email
FROM tutor_sessions ts
JOIN auth.users u ON ts.user_id = u.id
WHERE ts.dialog_id = $1
ORDER BY ts.created_at DESC;

-- Check if user has practiced a dialog before
SELECT COUNT(*) FROM tutor_sessions
WHERE user_id = $1 AND dialog_id = $2 AND completed_at IS NOT NULL;
```

---

## Test Cases

1. **Migration runs successfully:** No errors during execution
2. **Columns exist:** `dialog_id` and `selected_role` present
3. **Foreign key works:** Can insert with valid dialog_id
4. **Foreign key constraint:** Cannot insert with invalid dialog_id
5. **Nullable works:** Can insert tutor_sessions without dialog_id (backward compatible)
6. **Indexes created:** Verify with `\d+ tutor_sessions` in psql
7. **Rollback works:** Schema returns to original state

---

## Definition of Done

- [ ] Migration SQL written
- [ ] Migration tested locally
- [ ] Foreign key constraint verified
- [ ] Indexes created and verified
- [ ] Rollback plan tested
- [ ] Migration file committed
- [ ] Documentation updated
- [ ] Ready for production deployment
