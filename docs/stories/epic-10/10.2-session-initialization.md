# Story 10.2: Session Initialization

**Epic:** Dialog Roleplay Tutor
**Priority:** High
**Effort:** 3 hours
**Dependencies:** Story 10.7 (Database Schema)

---

## User Story

**As a** student
**I want to** start a roleplay session
**So that** the AI can begin the dialog as the opposite character

---

## Acceptance Criteria

- [ ] POST `/api/tutor/dialog/start` endpoint created
- [ ] Creates `tutor_sessions` record with `dialog_id` and `selected_role`
- [ ] AI generates first line as opposite character
- [ ] First AI message displayed to user
- [ ] Session state transitions to "active roleplay"
- [ ] Loading spinner shown during initialization

---

## Technical Tasks

1. Create `app/api/tutor/dialog/start/route.ts`
   - Auth check (user logged in)
   - Validate request body (dialogId, selectedRole, level)
   - Fetch dialog exchanges from database
   - Identify opposite character
   - Create tutor_sessions record
   - Generate first AI message via LangChain

2. Create `lib/dialog-tutor-tools.ts`
   - `startDialogRoleplayTool` - LangChain tool definition
   - Build system prompt for character AI
   - Include dialog context, setting, and exchanges
   - Generate natural first line from opposite character
   - Return sessionId + aiMessage + turnNumber

3. Update `DialogRoleplayPanel.tsx`
   - Handle "Start Roleplay" button click
   - Call `/api/tutor/dialog/start` API
   - Display loading state
   - On success: show AI message, transition to active stage
   - On error: show error toast, stay in selection stage

4. Database interaction
   - Insert into `tutor_sessions` with new columns
   - Insert first turn into `dialog_turns` (ai_message only)

---

## API Contract

### Request
```typescript
POST /api/tutor/dialog/start
{
  dialogId: string,      // UUID of lesson_dialogs record
  selectedRole: string,  // e.g., "María", "Carlos"
  level: CEFRLevel       // "A1" | "A2" | "B1" | "B2" | "C1" | "C2"
}
```

### Response (Success)
```typescript
{
  sessionId: string,
  aiMessage: string,
  oppositeCharacter: string,
  turnNumber: number
}
```

### Response (Error)
```typescript
{
  error: string
}
```

---

## AI System Prompt Template

```typescript
`You are playing ${oppositeCharacter} in this Spanish dialog.

CONTEXT: ${context}
SETTING: ${setting}

ORIGINAL DIALOG (for reference):
${formatExchanges(exchanges)}

The student is playing ${selectedRole} at ${level} level.

Guidelines:
- Stay in character as ${oppositeCharacter}
- Start the conversation naturally
- Match the general tone of the original dialog
- Use vocabulary appropriate for ${level} level
- Be warm and encouraging
- Speak ONLY in Spanish

Generate your first line as ${oppositeCharacter}:`
```

---

## Error Handling

- **Invalid dialogId:** Return 404 "Dialog not found"
- **User not authenticated:** Return 401 "Unauthorized"
- **Missing required fields:** Return 400 "Invalid request"
- **LangChain timeout:** Retry once, then return 500 with message
- **Database error:** Log and return 500 "Internal server error"

---

## Test Cases

1. **Success flow:** Valid request → session created → AI message returned
2. **Invalid dialog:** Non-existent dialogId → 404 error
3. **Missing auth:** No session token → 401 error
4. **LangChain failure:** AI timeout → graceful error message
5. **Spanish validation:** AI message is in Spanish only

---

## Definition of Done

- [ ] API endpoint implemented and tested
- [ ] LangChain tool created
- [ ] Frontend integration complete
- [ ] Error handling covers all edge cases
- [ ] Loading states implemented
- [ ] Manual testing with real dialog data
- [ ] No console errors or warnings
