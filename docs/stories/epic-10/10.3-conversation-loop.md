# Story 10.3: Interactive Conversation Loop

**Epic:** Dialog Roleplay Tutor
**Priority:** High
**Effort:** 3 hours
**Dependencies:** Story 10.2 (Session Initialization)

---

## User Story

**As a** student
**I want to** type my character's lines and receive AI responses
**So that** I can practice the dialog interactively

---

## Acceptance Criteria

- [ ] User can type their line in text input
- [ ] Submit button sends line to backend
- [ ] POST `/api/tutor/dialog/turn` validates grammar/vocab
- [ ] AI responds with opposite character's next line
- [ ] Corrections shown inline (if errors detected)
- [ ] Conversation history displays alternating messages
- [ ] Loading states during AI response
- [ ] Enter key submits message

---

## Technical Tasks

1. Create `app/api/tutor/dialog/turn/route.ts`
   - Validate sessionId and userResponse
   - Analyze user message for errors (using `analyzeUserMessageTool`)
   - Generate AI response via LangChain
   - Save user response to previous turn
   - Create new turn with AI message
   - Return aiMessage + correction + turnNumber + shouldEnd

2. Update `DialogRoleplayPanel.tsx` - Active Stage
   - Message history display (AI vs User bubbles)
   - Text input with submit button
   - Loading spinner while processing turn
   - Display correction feedback inline
   - Auto-scroll to latest message
   - Keyboard handler for Enter key

3. Create message bubble components
   - `AIMessage.tsx` - Character name, Spanish text
   - `UserMessage.tsx` - User's text, correction feedback
   - Different styling for AI vs User

4. Error correction display
   - Show green checkmark if no errors
   - Show yellow warning if errors detected
   - Expandable section with error details
   - Category labels (grammar/vocab/syntax)

---

## API Contract

### Request
```typescript
POST /api/tutor/dialog/turn
{
  sessionId: string,
  userResponse: string
}
```

### Response (Success)
```typescript
{
  aiMessage: string,
  turnNumber: number,
  shouldEnd: boolean,
  correction: {
    hasErrors: boolean,
    correctedText: string,
    errors: Array<{
      errorText: string,
      correction: string,
      explanation: string,
      category: 'grammar' | 'vocabulary' | 'syntax'
    }>
  }
}
```

---

## UI Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ­ Dialog Practice (Turn 2/10)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [Carlos (AI)]:                     â”‚
â”‚  "Hola, MarÃ­a. Â¿CÃ³mo estÃ¡s?"       â”‚
â”‚                                     â”‚
â”‚  [You (MarÃ­a)]:                     â”‚
â”‚  "Estoy bien, gracias."             â”‚
â”‚  âœ“ No errors detected               â”‚
â”‚                                     â”‚
â”‚  [Carlos (AI)]:                     â”‚
â”‚  "Â¿QuÃ© haces este fin de semana?"  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Type your line...             â”‚ â”‚
â”‚  â”‚ [MarÃ­a's response]            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [Send] [Terminar DiÃ¡logo]         â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Correction Feedback UI

```
[You (MarÃ­a)]:
"Yo voy al tienda maÃ±ana."

âš ï¸ 1 error detected (tap to see details)
   â†“ (expanded)

   Error: "al tienda"
   Correction: "a la tienda"
   Explanation: Use "la" with feminine nouns like "tienda"
   Category: Grammar
```

---

## Test Cases

1. **Normal turn:** User submits â†’ AI responds â†’ history updates
2. **Error correction:** User makes mistake â†’ correction shown
3. **No errors:** User correct â†’ green checkmark shown
4. **Loading state:** Submit button disabled during processing
5. **Auto-scroll:** New messages scroll into view
6. **Enter key:** Pressing Enter submits message
7. **Empty input:** Submit button disabled if input empty
8. **Long messages:** Text wraps properly in bubbles

---

## Definition of Done

- [ ] API endpoint implemented
- [ ] Frontend conversation UI complete
- [ ] Error correction display works
- [ ] Loading states implemented
- [ ] Keyboard shortcuts work
- [ ] Auto-scroll functions
- [ ] All acceptance criteria met
- [ ] Manual testing with various inputs
