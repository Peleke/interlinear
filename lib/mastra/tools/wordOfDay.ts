/**
 * Word of Day Generation Tool
 * Generates Spanish words with MW API + LLM content, or full LLM Latin words
 */

import { createTool } from '@mastra/core';
import { z } from 'zod';

// Spanish word curated list for random selection
const SPANISH_WORDS = [
  'serendipia', 'ef√≠mero', 'saudade', 'sobremesa', 'madrugada', 'querencia',
  'estrenar', 'tutelar', 'madrugar', 'trasnochar', 'merendar', 'empalagar',
  'disfrutar', 'reivindicar', 'ensimismarse', 'desvelo', 'melancol√≠a', 'a√±oranza',
  'regocijo', 'alborozo', 'bullicio', 'sosiego', 'quietud', 'pl√°cido',
  'sereno', 'apacible', 'bonanza', 'ventura', 'dicha', 'gozo', 'esperanza',
  'libertad', 'sabidur√≠a', 'belleza', 'coraje', 'honor', 'respeto', 'bondad',
  'mariposa', 'colibr√≠', 'murci√©lago', 'luci√©rnaga', 'girasol', 'amanecer',
  'atardecer', 'crep√∫sculo', 'medianoche', 'susurrar', 'murmurar', 'contemplar'
];

export const WordOfDayOutputSchema = z.object({
  word: z.string().describe('The selected word'),
  pronunciation: z.string().optional().describe('IPA pronunciation'),
  partOfSpeech: z.string().describe('Part of speech'),
  definitions: z.array(z.string()).describe('Array of definitions'),
  llmContent: z.string().describe('LLM-generated markdown content'),
  sourceData: z.any().optional().describe('Source API data for debugging')
});

export const generateSpanishWordTool = createTool({
  id: 'generate-spanish-word',
  description: 'Generate Spanish Word of Day with MW API + LLM content',
  inputSchema: z.object({
    date: z.string().describe('Date in YYYY-MM-DD format'),
  }),
  outputSchema: WordOfDayOutputSchema,
  execute: async ({ context }) => {
    const { date } = context;

    // Select random Spanish word based on date for consistency
    const dateObj = new Date(date);
    const dayOfYear = Math.floor((dateObj.getTime() - new Date(dateObj.getFullYear(), 0, 0).getTime()) / (1000 * 60 * 60 * 24));
    const wordIndex = dayOfYear % SPANISH_WORDS.length;
    const selectedWord = SPANISH_WORDS[wordIndex];

    // This will be populated by the LLM via the workflow
    return {
      word: selectedWord,
      pronunciation: '',
      partOfSpeech: '',
      definitions: [],
      llmContent: '',
      sourceData: { selectedWord }
    };
  },
});

export const generateLatinWordTool = createTool({
  id: 'generate-latin-word',
  description: 'Generate complete Latin Word of Day using LLM',
  inputSchema: z.object({
    date: z.string().describe('Date in YYYY-MM-DD format'),
  }),
  outputSchema: WordOfDayOutputSchema,
  execute: async ({ context }) => {
    // For Latin, everything is generated by LLM
    // This will be populated by the LLM via the workflow
    return {
      word: '',
      pronunciation: '',
      partOfSpeech: '',
      definitions: [],
      llmContent: '',
      sourceData: { fullLLMGeneration: true }
    };
  },
});

/**
 * Spanish Word of Day Prompt
 * Uses MW API data + LLM enhancement
 */
export const SPANISH_WORD_PROMPT = `You are a witty Spanish language expert creating engaging Word of Day content.

TASK: Create content for the Spanish word provided, using the Merriam-Webster data as a foundation.

INPUT DATA:
Word: {selectedWord}
MW API Response: {mwApiData}

Your job is to:
1. Use the MW API data for basic definition and pronunciation
2. Create engaging LLM content as markdown

OUTPUT FORMAT (as valid JSON):
{
  "word": "{selectedWord}",
  "pronunciation": "[IPA from MW or your best guess]",
  "partOfSpeech": "[from MW data]",
  "definitions": ["first definition", "second definition", "third definition"],
  "llmContent": "MARKDOWN_CONTENT_HERE",
  "sourceData": { "mwApiUsed": true }
}

MARKDOWN CONTENT should include:
## üé≠ Ejemplos Creativos
2-3 funny, memorable example sentences in Spanish with English translations.

## üìö Etimolog√≠a e Historia
1-2 paragraphs about the word's origins, evolution, and cultural significance.

## üí° Notas de Uso
Short paragraph about usage, nuances, common mistakes, or interesting variations.

Make it engaging, educational, and slightly humorous. Use emojis sparingly but effectively.`;

/**
 * Latin Word of Day Prompt
 * Full LLM generation - word selection, IPA, definitions, everything
 */
export const LATIN_WORD_PROMPT = `You are a classical Latin scholar creating engaging Word of Day content.

TASK: Generate a complete Latin Word of Day entry. Select an interesting, representative Latin word and create comprehensive content about it.

GUIDELINES FOR WORD SELECTION:
- Choose words that showcase Latin's influence on modern languages
- Pick words with interesting stories (historical, cultural, linguistic)
- Avoid overly obscure words - aim for educational value
- Consider classical authors, philosophy, law, nature, human experience
- Examples: veritas, virtus, carpe, memento, aeternum, etc.

OUTPUT FORMAT (as valid JSON):
{
  "word": "[your selected Latin word]",
  "pronunciation": "[Classical Latin IPA]",
  "partOfSpeech": "[grammatical category]",
  "definitions": ["primary meaning", "secondary meaning", "contextual meaning"],
  "llmContent": "MARKDOWN_CONTENT_HERE",
  "sourceData": { "fullLLMGeneration": true, "date": "{date}" }
}

MARKDOWN CONTENT should include:
## üèõÔ∏è Classical Examples
2-3 examples showing the word in classical Latin texts with English translations.

## üìú Etymology & Legacy
1-2 paragraphs about the word's origins and how it influenced modern languages.

## ‚öñÔ∏è Cultural Significance
Short paragraph about the word's role in Roman culture, law, philosophy, or daily life.

Generate IPA using Classical Latin pronunciation. Make it scholarly but accessible.`;

export type WordOfDayOutput = z.infer<typeof WordOfDayOutputSchema>;

/**
 * Generate real content for Spanish words
 */
function generateRealSpanishContent(word: string) {
  // Real Spanish word data dictionary
  const spanishWordData: Record<string, {
    pronunciation: string;
    partOfSpeech: string;
    definitions: string[];
    staticContent: string;
  }> = {
    sosiego: {
      pronunciation: "/so.'sje.…£o/",
      partOfSpeech: "sustantivo masculino",
      definitions: [
        "Tranquilidad, calma, paz interior",
        "Estado de quietud y reposo del √°nimo",
        "Serenidad en medio de las dificultades"
      ],
      staticContent: `# üá™üá∏ sosiego

## üìö Etimolog√≠a e Historia
Del lat√≠n *subsidium*, que originalmente significaba "ayuda" o "socorro". La palabra evolucion√≥ a trav√©s del espa√±ol antiguo hasta adoptar el sentido moderno de tranquilidad y paz interior. Es una palabra profundamente arraigada en la literatura espa√±ola, apareciendo frecuentemente en obras cl√°sicas desde el Siglo de Oro.

## üí° Notas de Uso
*Sosiego* es una palabra culta y po√©tica, m√°s elegante que "tranquilidad" o "calma". Se usa especialmente en contextos literarios o cuando se quiere expresar una paz profunda y duradera. No confundir con "sosegado" (adjetivo) - *sosiego* es el sustantivo que describe el estado mismo de calma.

*Ejemplos din√°micos disponibles con el bot√≥n de refrescar.*`
    },
    serendipia: {
      pronunciation: "/se.…æen.'di.pja/",
      partOfSpeech: "sustantivo femenino",
      definitions: [
        "Descubrimiento afortunado e inesperado",
        "Hallazgo valioso que se produce de manera accidental",
        "Capacidad de encontrar algo bueno sin buscarlo"
      ],
      staticContent: `# üá™üá∏ serendipia

## üìö Etimolog√≠a e Historia
Del ingl√©s *serendipity*, acu√±ado por Horace Walpole en 1754 bas√°ndose en el cuento persa "Los tres pr√≠ncipes de Serendip". La RAE incorpor√≥ esta palabra al diccionario en 2014, reconociendo su uso creciente en espa√±ol. Es un ejemplo perfecto de c√≥mo el idioma se enriquece con pr√©stamos adaptados.

## üí° Notas de Uso
Palabra de uso culto y relativamente moderno. Se emplea especialmente en contextos cient√≠ficos, creativos o literarios para describir descubrimientos fortuitos. Su pronunciaci√≥n debe mantener el diptongo "ia" al final.`
    },
    ef√≠mero: {
      pronunciation: "/e.'fi.me.…æo/",
      partOfSpeech: "adjetivo",
      definitions: [
        "Que dura muy poco tiempo, pasajero",
        "De existencia fugaz y transitoria",
        "Que tiene una vida muy breve"
      ],
      staticContent: `# üá™üá∏ ef√≠mero

## üìö Etimolog√≠a e Historia
Del griego *ephƒìmeros* (·ºêœÜŒÆŒºŒµœÅŒøœÇ), compuesto por *epi* (sobre) y *hƒìmera* (d√≠a), literalmente "que dura un d√≠a". Originalmente se aplicaba a los insectos que viven solo un d√≠a. La met√°fora se extendi√≥ para describir todo lo transitorio y fugaz.

## üí° Notas de Uso
Palabra culta con connotaciones po√©ticas. Se usa para enfatizar la brevedad o fragilidad de algo valioso. Es m√°s elegante que "temporal" o "breve", y a√±ade un matiz melanc√≥lico o filos√≥fico.`
    }
  };

  // Return data for the word, or generic content if not found
  return spanishWordData[word] || {
    pronunciation: "/Ààword/",
    partOfSpeech: "sustantivo",
    definitions: [`Palabra espa√±ola: ${word}`, "Definici√≥n en desarrollo", "Significado por determinar"],
    staticContent: `# üá™üá∏ ${word}\n\n## üìö Etimolog√≠a e Historia\nPalabra espa√±ola con historia interesante.\n\n## üí° Notas de Uso\nUso tradicional en el idioma espa√±ol.`
  };
}

/**
 * Generate Spanish Word of Day (function version for workflow)
 */
export async function generateSpanishWordOfDay(input: { date: string }) {
  try {
    const { date } = input;

    // Select word based on date for consistency
    const dateObj = new Date(date);
    const dayOfYear = Math.floor((dateObj.getTime() - new Date(dateObj.getFullYear(), 0, 0).getTime()) / (1000 * 60 * 60 * 24));
    const wordIndex = dayOfYear % SPANISH_WORDS.length;
    const selectedWord = SPANISH_WORDS[wordIndex];

    // Generate real content for the selected word
    const wordContent = generateRealSpanishContent(selectedWord);

    const result = {
      word: selectedWord,
      pronunciation: wordContent.pronunciation,
      partOfSpeech: wordContent.partOfSpeech,
      definitions: wordContent.definitions,
      staticContent: wordContent.staticContent,
      sourceData: { word: selectedWord, generated: true, date }
    };

    return { success: true, data: result };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Spanish word generation failed'
    };
  }
}

/**
 * Generate real content for Latin words
 */
function generateRealLatinContent(word: string) {
  // Real Latin word data dictionary
  const latinWordData: Record<string, {
    pronunciation: string;
    partOfSpeech: string;
    definitions: string[];
    staticContent: string;
  }> = {
    honor: {
      pronunciation: "/Ààho.nor/",
      partOfSpeech: "nomen (m.)",
      definitions: [
        "Honor, integrity, moral excellence",
        "Public esteem, reputation, dignity",
        "Office, position of responsibility"
      ],
      staticContent: `# üèõÔ∏è honor

## üìú Etymology & Legacy
From Proto-Indo-European *ghon-os-, related to *ghon- meaning "to shine" or "to be bright." The concept of honor as moral brilliance permeated Roman culture and law. This word directly influenced Spanish *honor*, French *honneur*, Italian *onore*, and English *honor*.

## ‚öñÔ∏è Cultural Significance
Central to Roman virtue ethics, *honor* was not just personal integrity but also public recognition of that integrity. Roman senators and citizens built their entire social standing on honor. The phrase "honor et virtus" (honor and virtue) became a common motto representing the ideal Roman character.

*Ejemplos din√°micos disponibles con el bot√≥n de refrescar.*`
    },
    veritas: {
      pronunciation: "/Ààwe.ri.tas/",
      partOfSpeech: "nomen (f.)",
      definitions: [
        "Truth, reality, facts",
        "Honesty, sincerity, authenticity",
        "Philosophical or divine truth"
      ],
      staticContent: `# üèõÔ∏è veritas

## üìú Etymology & Legacy
From Proto-Indo-European *wer- meaning "true" or "trustworthy." This root also gave us Germanic *war* (true) and Sanskrit *vara* (choice, excellent). The Harvard University motto "Veritas" reflects the enduring power of this concept in Western education and philosophy.

## ‚öñÔ∏è Cultural Significance
*Veritas* was personified as a goddess in Roman religion, often depicted with a mirror to reflect reality. Cicero famously wrote "Magna vis est veritatis" (Great is the power of truth). This concept shaped Roman law, rhetoric, and philosophy, distinguishing truth from mere opinion or appearance.`
    },
    virtus: {
      pronunciation: "/Ààwir.tuÀês/",
      partOfSpeech: "nomen (f.)",
      definitions: [
        "Virtue, moral excellence, character",
        "Courage, bravery in battle",
        "Strength, vigor, power"
      ],
      staticContent: `# üèõÔ∏è virtus

## üìú Etymology & Legacy
From *vir* (man) + *-tus* (abstract noun suffix), originally meaning "manliness" or "manly virtue." The concept evolved to encompass moral excellence for all people. English *virtue*, French *vertu*, Spanish *virtud* all derive from this foundational Latin concept.

## ‚öñÔ∏è Cultural Significance
One of the four cardinal virtues in Roman philosophy, alongside prudentia, temperantia, and iustitia. Roman soldiers received the *corona virtutis* (crown of virtue) for exceptional bravery. Cicero defined it as "virtus est animi habitus naturae modo atque rationi consentaneus" (virtue is a habit of mind consistent with nature and reason).`
    }
  };

  // Return data for the word, or generic content if not found
  return latinWordData[word] || {
    pronunciation: "/Ààla.tin/",
    partOfSpeech: "nomen",
    definitions: [`Classical Latin word: ${word}`, "Historical meaning", "Cultural significance"],
    staticContent: `# üèõÔ∏è ${word}\n\n## üìú Etymology & Legacy\nImportant Latin term with lasting influence.\n\n## ‚öñÔ∏è Cultural Significance\nSignificant role in Roman civilization.`
  };
}

/**
 * Generate Latin Word of Day (function version for workflow)
 */
export async function generateLatinWordOfDay(input: { date: string }) {
  try {
    const { date } = input;

    // Simple Latin words for testing
    const LATIN_WORDS = ['veritas', 'virtus', 'gloria', 'honor', 'sapientia', 'libertas'];

    const dateObj = new Date(date);
    const dayOfYear = Math.floor((dateObj.getTime() - new Date(dateObj.getFullYear(), 0, 0).getTime()) / (1000 * 60 * 60 * 24));
    const wordIndex = dayOfYear % LATIN_WORDS.length;
    const selectedWord = LATIN_WORDS[wordIndex];

    // Generate real content for the selected word
    const wordContent = generateRealLatinContent(selectedWord);

    const result = {
      word: selectedWord,
      pronunciation: wordContent.pronunciation,
      partOfSpeech: wordContent.partOfSpeech,
      definitions: wordContent.definitions,
      staticContent: wordContent.staticContent,
      sourceData: { word: selectedWord, generated: true, date }
    };

    return { success: true, data: result };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Latin word generation failed'
    };
  }
}

/**
 * Generate fresh sentences (for the refresh button)
 */
export async function generateFreshSentences(input: {
  word: string;
  language: 'spanish' | 'latin';
  definitions: string[];
  count?: number;
}) {
  const { word, language, count = 3 } = input;

  // Real example sentences for specific words
  const spanishExamples: Record<string, Array<{spanish: string, english: string, context: string}>> = {
    sosiego: [
      {
        spanish: "Despu√©s de a√±os de turbulencia, finalmente encontr√≥ sosiego en la meditaci√≥n.",
        english: "After years of turbulence, he finally found peace in meditation.",
        context: "Inner peace through spiritual practice"
      },
      {
        spanish: "El jard√≠n era su refugio de sosiego en medio del caos urbano.",
        english: "The garden was her refuge of tranquility in the midst of urban chaos.",
        context: "Finding calm in nature"
      },
      {
        spanish: "Con sosiego enfrent√≥ las cr√≠ticas, sin perder la compostura.",
        english: "With serenity, she faced the criticism without losing her composure.",
        context: "Maintaining calm under pressure"
      },
      {
        spanish: "La m√∫sica cl√°sica le tra√≠a un sosiego que ninguna otra cosa pod√≠a brindarle.",
        english: "Classical music brought him a peace that nothing else could provide.",
        context: "Art as source of tranquility"
      },
      {
        spanish: "En el sosiego del amanecer, las ideas flu√≠an con claridad meridiana.",
        english: "In the stillness of dawn, ideas flowed with crystal clarity.",
        context: "Creative inspiration in quiet moments"
      }
    ],
    serendipia: [
      {
        spanish: "Fue pura serendipia encontrar a su futura esposa en el aeropuerto equivocado.",
        english: "It was pure serendipity finding his future wife at the wrong airport.",
        context: "Life-changing accidental encounters"
      },
      {
        spanish: "La serendipia cient√≠fica llev√≥ al descubrimiento de la penicilina.",
        english: "Scientific serendipity led to the discovery of penicillin.",
        context: "Accidental scientific breakthroughs"
      },
      {
        spanish: "Amo la serendipia de las librer√≠as: siempre encuentro algo inesperado.",
        english: "I love the serendipity of bookstores: I always find something unexpected.",
        context: "Pleasant surprises in exploration"
      }
    ]
  };

  const latinExamples: Record<string, Array<{latin: string, english: string, context: string}>> = {
    honor: [
      {
        latin: "Honor est praemium virtutis.",
        english: "Honor is the reward of virtue.",
        context: "Classical moral philosophy"
      },
      {
        latin: "Sine honore vita non est vita.",
        english: "Life without honor is not life.",
        context: "Roman stoic principles"
      },
      {
        latin: "Honor in morte conservatur.",
        english: "Honor is preserved in death.",
        context: "Military and heroic ideals"
      }
    ],
    veritas: [
      {
        latin: "Veritas vincit omnia.",
        english: "Truth conquers all.",
        context: "Latin proverb about truth's power"
      },
      {
        latin: "In vino veritas, in aqua sanitas.",
        english: "In wine there is truth, in water there is health.",
        context: "Famous Latin saying about honesty"
      },
      {
        latin: "Magna est vis veritatis.",
        english: "Great is the power of truth.",
        context: "Cicero on truth's influence"
      }
    ],
    virtus: [
      {
        latin: "Virtus post nummos.",
        english: "Virtue after money.",
        context: "Horace's critique of materialistic priorities"
      },
      {
        latin: "Fortuna audaces iuvat, virtus omnes.",
        english: "Fortune helps the bold, virtue helps everyone.",
        context: "Roman philosophy on virtue's universal benefit"
      },
      {
        latin: "Virtus sola nobilitas.",
        english: "Virtue alone is nobility.",
        context: "True nobility comes from character"
      }
    ]
  };

  const sentences = [];
  const examples = language === 'spanish' ? spanishExamples[word] : latinExamples[word];

  if (examples && examples.length > 0) {
    // Use real examples, cycling through them
    for (let i = 0; i < count; i++) {
      const example = examples[i % examples.length];
      sentences.push(example);
    }
  } else {
    // Fallback for words not in our database
    for (let i = 1; i <= count; i++) {
      if (language === 'spanish') {
        sentences.push({
          spanish: `Esta es una oraci√≥n de ejemplo con la palabra "${word}".`,
          english: `This is an example sentence with the word "${word}".`,
          context: `General usage context ${i}`
        });
      } else {
        sentences.push({
          latin: `Hic est exemplum cum verbo "${word}".`,
          english: `This is an example with the word "${word}".`,
          context: `Classical context ${i}`
        });
      }
    }
  }

  return { success: true, sentences };
}